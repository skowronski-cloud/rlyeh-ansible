# tools for checking various clusters

TODO:
- [x] basic patroni checks
- [x] basic galera checks
- [x] fancy tables
- [ ] use ansible vars to get hosts
- [ ] improve code quality

## MySQL - Galera

```bash
python3 mysql_galera_check.py
```

example:

```
╒═════════╤═══╤════════╤═════════╤═══════╤══════╤════╤══════╤══════════════╤══════════════╤═════════╤═════════╤═════════╤═══════╤═══════╤══════╤══════════╕
│ node    │ i │ local  │ cluster │ ready │ conn │ si │ conf │ local        │ cluster      │    last │    recv │    send │  recv │  repl │ thrd │ server   │
│         │ d │ state  │ state   │       │      │ ze │   id │ state_uuid   │ state_uuid   │  commit │   queue │   queue │   cnt │   cnt │ conn │ time     │
╞═════════╪═══╪════════╪═════════╪═══════╪══════╪════╪══════╪══════════════╪══════════════╪═════════╪═════════╪═════════╪═══════╪═══════╪══════╪══════════╡
│ mysql01 │ 0 │ Synced │ Primary │ ON    │ ON   │  4 │   71 │ ff83b4363845 │ ff83b4363845 │ 3676514 │ 0.01990 │ 0.00000 │ 32806 │  9582 │    2 │ 20:51:58 │
├─────────┼───┼────────┼─────────┼───────┼──────┼────┼──────┼──────────────┼──────────────┼─────────┼─────────┼─────────┼───────┼───────┼──────┼──────────┤
│ mysql02 │ 1 │ Synced │ Primary │ ON    │ ON   │  4 │   71 │ ff83b4363845 │ ff83b4363845 │ 3676514 │ 0.01695 │ 0.00010 │ 32868 │  9531 │    1 │ 20:51:59 │
├─────────┼───┼────────┼─────────┼───────┼──────┼────┼──────┼──────────────┼──────────────┼─────────┼─────────┼─────────┼───────┼───────┼──────┼──────────┤
│ mysql03 │ 2 │ Synced │ Primary │ ON    │ ON   │  4 │   71 │ ff83b4363845 │ ff83b4363845 │ 3676514 │ 0.01493 │ 0.00010 │ 32825 │  9554 │    1 │ 20:51:59 │
├─────────┼───┼────────┼─────────┼───────┼──────┼────┼──────┼──────────────┼──────────────┼─────────┼─────────┼─────────┼───────┼───────┼──────┼──────────┤
│ mysql04 │ 3 │ Synced │ Primary │ ON    │ ON   │  4 │   71 │ ff83b4363845 │ ff83b4363845 │ 3676514 │ 0.01019 │ 0.00008 │ 29541 │ 12892 │    1 │ 20:52:00 │
╘═════════╧═══╧════════╧═════════╧═══════╧══════╧════╧══════╧══════════════╧══════════════╧═════════╧═════════╧═════════╧═══════╧═══════╧══════╧══════════╛
```

## PostgreSQL - Patroni

```bash
python3 psql_patroni_check.py
```

example:

```
etcd on psql05 not responding:
╒════════╤═════════╤═════════╤═══════╤═══════╤═════╤═══════╤═════╤═════╤══════════╕
│ node   │ role    │ state   │ roles │ state │ TL  │ TL    │ lag │ lag │ server   │
│        │ local   │ local   │ 12345 │ 12345 │ loc │ avg   │ loc │ avg │ time     │
╞════════╪═════════╪═════════╪═══════╪═══════╪═════╪═══════╪═════╪═════╪══════════╡
│ psql01 │ Replica │ running │ RRRR? │ rrrr? │ 361 │ 361.0 │ 0   │ 0.0 │ 22:10:31 │
├────────┼─────────┼─────────┼───────┼───────┼─────┼───────┼─────┼─────┼──────────┤
│ psql02 │ Replica │ running │ RRRR? │ rrrr? │ 361 │ 361.0 │ 0   │ 0.0 │ 22:10:31 │
├────────┼─────────┼─────────┼───────┼───────┼─────┼───────┼─────┼─────┼──────────┤
│ psql03 │ Leader  │ running │ LLLL? │ rrrr? │ 361 │ 361.0 │ --- │ --- │ 22:10:31 │
├────────┼─────────┼─────────┼───────┼───────┼─────┼───────┼─────┼─────┼──────────┤
│ psql04 │ Replica │ running │ RRRR? │ rrrr? │ 361 │ 361.0 │ 0   │ 0.0 │ 22:10:31 │
├────────┼─────────┼─────────┼───────┼───────┼─────┼───────┼─────┼─────┼──────────┤
│ psql05 │ ???     │ ???     │ ????? │ ????? │ ??? │ ???   │ ??? │ ??? │ 22:10:31 │
╘════════╧═════════╧═════════╧═══════╧═══════╧═════╧═══════╧═════╧═════╧══════════╛

replica rebuilding on psql05:
╒════════╤═════════╤══════════════════╤═══════╤═══════╤═════╤═════╤═════════╤═════╤══════════╕
│ node   │ role    │ state            │ roles │ state │ TL  │  TL │ lag     │ lag │ server   │
│        │ local   │ local            │ 12345 │ 12345 │ loc │ avg │ loc     │ avg │ time     │
╞════════╪═════════╪══════════════════╪═══════╪═══════╪═════╪═════╪═════════╪═════╪══════════╡
│ psql01 │ Replica │ running          │ RRRRR │ rrrrr │ 361 │ 361 │ 0       │ 0.0 │ 22:12:20 │
├────────┼─────────┼──────────────────┼───────┼───────┼─────┼─────┼─────────┼─────┼──────────┤
│ psql02 │ Replica │ running          │ RRRRR │ rrrrr │ 361 │ 361 │ 0       │ 0.0 │ 22:12:20 │
├────────┼─────────┼──────────────────┼───────┼───────┼─────┼─────┼─────────┼─────┼──────────┤
│ psql03 │ Leader  │ running          │ LLLLL │ rrrrr │ 361 │ 361 │ ---     │ --- │ 22:12:20 │
├────────┼─────────┼──────────────────┼───────┼───────┼─────┼─────┼─────────┼─────┼──────────┤
│ psql04 │ Replica │ running          │ RRRRR │ rrrrr │ 361 │ 361 │ 0       │ 0.0 │ 22:12:20 │
├────────┼─────────┼──────────────────┼───────┼───────┼─────┼─────┼─────────┼─────┼──────────┤
│ psql05 │ Replica │ creating replica │ RRRRR │ ssscc │ ??? │  -1 │ unknown │ ??? │ 22:12:20 │
╘════════╧═════════╧══════════════════╧═══════╧═══════╧═════╧═════╧═════════╧═════╧══════════╛

all healthy:
╒════════╤═════════╤═════════╤═══════╤═══════╤═════╤═════╤═════╤═════╤══════════╕
│ node   │ role    │ state   │ roles │ state │  TL │  TL │ lag │ lag │ server   │
│        │ local   │ local   │ 12345 │ 12345 │ loc │ avg │ loc │ avg │ time     │
╞════════╪═════════╪═════════╪═══════╪═══════╪═════╪═════╪═════╪═════╪══════════╡
│ psql01 │ Replica │ running │ RRRRR │ rrrrr │ 361 │ 361 │ 0   │ 0.0 │ 22:12:40 │
├────────┼─────────┼─────────┼───────┼───────┼─────┼─────┼─────┼─────┼──────────┤
│ psql02 │ Replica │ running │ RRRRR │ rrrrr │ 361 │ 361 │ 0   │ 0.0 │ 22:12:40 │
├────────┼─────────┼─────────┼───────┼───────┼─────┼─────┼─────┼─────┼──────────┤
│ psql03 │ Leader  │ running │ LLLLL │ rrrrr │ 361 │ 361 │ --- │ --- │ 22:12:40 │
├────────┼─────────┼─────────┼───────┼───────┼─────┼─────┼─────┼─────┼──────────┤
│ psql04 │ Replica │ running │ RRRRR │ rrrrr │ 361 │ 361 │ 0   │ 0.0 │ 22:12:40 │
├────────┼─────────┼─────────┼───────┼───────┼─────┼─────┼─────┼─────┼──────────┤
│ psql05 │ Replica │ running │ RRRRR │ rrrrr │ 361 │ 361 │ 0   │ 0.0 │ 22:12:40 │
╘════════╧═════════╧═════════╧═══════╧═══════╧═════╧═════╧═════╧═════╧══════════╛
```
